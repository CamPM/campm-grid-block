<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zen Block Blast v0.02</title>
    <style>
        :root { --bg: #fdfdfd; --grid: #e0e0e0; --accent: #a8dadc; --text: #457b9d; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none; transition: background 0.5s ease; }
        
        /* Layout Sections */
        #ui-layer { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-around; font-weight: 600; }
        #canvas-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        canvas { touch-action: none; border-radius: 12px; cursor: grab; }
        
        /* Overlays */
        .modal { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 100; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .active { display: flex !important; }
        
        /* Buttons */
        .btn-group { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; justify-content: center; }
        button { padding: 10px 18px; border: 2px solid var(--text); background: transparent; color: var(--text); border-radius: 20px; font-weight: bold; cursor: pointer; }
        button:active { transform: scale(0.95); }
        .hidden { display: none; }
        
        .powerup-bar { display: flex; gap: 20px; margin-top: 5px; }
        .powerup { font-size: 12px; display: flex; flex-direction: column; }
    </style>
</head>
<body>

<div id="ui-layer">
    <div>SCORE: <span id="score">0</span></div>
    <div>HIGH: <span id="highscore">0</span></div>
</div>

<div id="canvas-container">
    <canvas id="gameCanvas"></canvas>
    
    <div class="powerup-bar">
        <div class="powerup"><button onclick="usePowerup('rotate')">ðŸ”„</button><span>Rotate</span></div>
        <div class="powerup"><button onclick="usePowerup('clear')">ðŸ’£</button><span>Blast</span></div>
        <div class="powerup"><button onclick="usePowerup('new')">ðŸŽ²</button><span>New</span></div>
    </div>

    <div class="btn-group">
        <button id="fsBtn" onclick="toggleFS()" class="hidden">Full Screen</button>
        <button id="muteBtn" onclick="toggleMute()">Sound: ON</button>
        <button onclick="openModal('helpModal')">Help</button>
        <button onclick="openModal('shopModal')">Shop</button>
    </div>
</div>

<div id="helpModal" class="modal">
    <h2>How to Play</h2>
    <p>Drag shapes onto the grid to complete rows or columns.<br>Complete lines to clear space and earn points.</p>
    <p><strong>Powerups:</strong><br>Rotate: Spin a shape before placing.<br>Blast: Clear a 3x3 area.<br>Refresh: Swap your current shapes.</p>
    <button onclick="closeModals()">Got it!</button>
</div>

<div id="shopModal" class="modal">
    <h2>Zen Shop</h2>
    <div id="shopItems">Themes (Unlocked on clear) | Skins Coming Soon</div>
    <button onclick="closeModals()">Close</button>
</div>

<div id="gameOverModal" class="modal">
    <h1>Game Over</h1>
    <p>Final Score: <span id="finalScore">0</span></p>
    <button onclick="resetGame()">Try Again</button>
</div>

<script>
/** * SECTION: DEBUG & CONFIG
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const isAndroid = /Android/i.test(navigator.userAgent);
if(isAndroid) document.getElementById('fsBtn').classList.remove('hidden');

let config = {
    gridSize: 8,
    cellSize: 0,
    score: 0,
    isMuted: false,
    themeIdx: 0,
    unlockedThemes: [0, 1]
};

// Theme Definitions [Background, Grid, Block, Highlight]
const THEMES = [
    {bg: '#fdfdfd', grid: '#e0e0e0', block: '#a8dadc', high: '#457b9d'}, // White/Blue
    {bg: '#a8dadc', grid: '#f1faee', block: '#fdfdfd', high: '#1d3557'}, // Blue/White
    {bg: '#222', grid: '#333', block: '#ffb703', high: '#fb8500'}       // Example Dark Theme
];

/**
 * SECTION: AUDIO ENGINE (CHILL)
 */
const audio = new (window.AudioContext || window.webkitAudioContext)();
function playSoftSound(type) {
    if(config.isMuted) return;
    const osc = audio.createOscillator();
    const gain = audio.createGain();
    osc.type = 'sine'; // Sine for chill vibe
    osc.frequency.setValueAtTime(type === 'place' ? 220 : 440, audio.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audio.currentTime + 0.5);
    osc.connect(gain); gain.connect(audio.destination);
    osc.start(); osc.stop(audio.currentTime + 0.5);
}

/**
 * SECTION: CORE GAME LOGIC
 */
let board = [];
let shapes = [];
let dragging = null;

function init() {
    config.cellSize = Math.min(window.innerWidth * 0.9, 400) / config.gridSize;
    canvas.width = config.cellSize * config.gridSize;
    canvas.height = canvas.width + 160;
    board = Array(config.gridSize).fill().map(() => Array(config.gridSize).fill(0));
    spawnShapes();
    animate();
}

function spawnShapes() {
    shapes = [];
    for(let i=0; i<3; i++) {
        shapes.push({
            map: [[1,1],[1,1]], // Simplification for v0.02
            x: i * (canvas.width/3) + 15,
            y: canvas.width + 30,
            ox: i * (canvas.width/3) + 15,
            oy: canvas.width + 30,
            active: true
        });
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const theme = THEMES[config.themeIdx];
    document.body.style.backgroundColor = theme.bg;

    // Draw Grid
    for(let r=0; r<config.gridSize; r++) {
        for(let c=0; c<config.gridSize; c++) {
            ctx.fillStyle = board[r][c] ? theme.block : theme.grid;
            ctx.fillRect(c*config.cellSize, r*config.cellSize, config.cellSize-2, config.cellSize-2);
        }
    }

    // Draw Shapes & Dragging Preview
    shapes.forEach((s, i) => {
        if(!s.active) return;
        ctx.fillStyle = theme.block;
        s.map.forEach((row, ri) => {
            row.forEach((col, ci) => {
                if(col) ctx.fillRect(s.x + ci*(config.cellSize/1.5), s.y + ri*(config.cellSize/1.5), config.cellSize/1.8, config.cellSize/1.8);
            });
        });
    });
}

/**
 * SECTION: INTERACTION
 */
canvas.addEventListener('touchstart', handleStart);
canvas.addEventListener('touchmove', handleMove);
canvas.addEventListener('touchend', handleEnd);

function handleStart(e) {
    const t = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const mx = t.clientX - rect.left;
    const my = t.clientY - rect.top;
    shapes.forEach((s, i) => {
        if(s.active && mx > s.x && my > s.y) dragging = i;
    });
}

function handleMove(e) {
    if(dragging === null) return;
    const t = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    shapes[dragging].x = t.clientX - rect.left - 30;
    shapes[dragging].y = t.clientY - rect.top - 30;
}

function handleEnd() {
    if(dragging === null) return;
    const s = shapes[dragging];
    const gridX = Math.round(s.x / config.cellSize);
    const gridY = Math.round(s.y / config.cellSize);

    // Collision Check: Must be empty
    if(isValidPlacement(s, gridY, gridX)) {
        placeShape(s, gridY, gridX);
        playSoftSound('place');
        checkLines();
    } else {
        s.x = s.ox; s.y = s.oy;
    }
    dragging = null;
    if(shapes.every(sh => !sh.active)) spawnShapes();
}

function isValidPlacement(shape, r, c) {
    if(r < 0 || c < 0 || r + shape.map.length > config.gridSize || c + shape.map[0].length > config.gridSize) return false;
    for(let ri=0; ri<shape.map.length; ri++) {
        for(let ci=0; ci<shape.map[0].length; ci++) {
            if(shape.map[ri][ci] && board[r+ri][c+ci]) return false; // Overlap check
        }
    }
    return true;
}

function checkLines() {
    let rowsToClear = [];
    let colsToClear = [];

    // Rows
    for(let r=0; r<config.gridSize; r++) if(board[r].every(v => v === 1)) rowsToClear.push(r);
    // Cols
    for(let c=0; c<config.gridSize; c++) {
        let full = true;
        for(let r=0; r<config.gridSize; r++) if(!board[r][c]) full = false;
        if(full) colsToClear.push(c);
    }

    rowsToClear.forEach(r => board[r].fill(0));
    colsToClear.forEach(c => { for(let r=0; r<config.gridSize; r++) board[r][c] = 0; });

    if(rowsToClear.length || colsToClear.length) {
        config.score += (rowsToClear.length + colsToClear.length) * 100;
        document.getElementById('score').innerText = config.score;
        playSoftSound('clear');
        checkBoardEmpty();
    }
}

function checkBoardEmpty() {
    let empty = true;
    board.forEach(row => row.forEach(cell => { if(cell) empty = false; }));
    if(empty) {
        config.themeIdx = (config.themeIdx + 1) % THEMES.length; // Cycle theme
    }
}

/**
 * SECTION: UI HELPERS
 */
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }
function toggleMute() { 
    config.isMuted = !config.isMuted; 
    document.getElementById('muteBtn').innerText = `Sound: ${config.isMuted ? 'OFF' : 'ON'}`;
}
function toggleFS() { if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen(); }

function animate() { draw(); requestAnimationFrame(animate); }
init();
</script>
</body>
</html>
